<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inter Musica - Mini Front</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
        h2 { margin-top: 28px; }
        .row { display: flex; gap: 12px; flex-wrap: wrap; }
        .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; min-width: 320px; flex: 1; }
        label { display: block; font-size: 12px; margin: 8px 0 4px; color: #555; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 10px 12px; border: 0; border-radius: 8px; cursor: pointer; }
        button.primary { background: #111; color: #fff; }
        button.gray { background: #eee; }
        pre { background: #0b1020; color: #d7e0ff; padding: 12px; border-radius: 10px; overflow:auto; }
        .small { font-size: 12px; color: #666; }
        .tokens { display:flex; gap:10px; flex-wrap:wrap; }
        .tokenBox { flex:1; min-width: 320px; }
    </style>
</head>
<body>
<h1>Inter Musica - Mini Front</h1>
<p class="small">
    기본 baseUrl: <code>http://localhost:8080</code> (같은 서버에서 서빙되면 CORS 없이 동작)
</p>

<div class="card">
    <label>Base URL</label>
    <input id="baseUrl" value="http://localhost:8080" />
    <div class="small">서버 포트가 다르면 수정하세요.</div>
</div>

<h2>1) 계정</h2>

<div class="row">
    <div class="card">
        <h3>회원가입 (Signup)</h3>

        <label>email</label>
        <input id="suEmail" value="user1@test.com" />

        <label>password</label>
        <input id="suPw" value="1234" />

        <label>instrument</label>
        <input id="suInst" value="DRUM" />

        <label>level</label>
        <select id="suLevel">
            <option>HOBBY_UNDER_A_YEAR</option>
            <option>HOBBY_UNDER_FIVE_YEAR</option>
            <option selected>HOBBY_OVER_FIVE_YEAR</option>
            <option>MAJOR_STUDENT</option>
        </select>

        <label>region</label>
        <input id="suRegion" value="SEOUL_MAPO" />

        <div style="margin-top:10px;">
            <button class="primary" onclick="signup()">POST /auth/signup</button>
        </div>
    </div>

    <div class="card">
        <h3>로그인 (Login)</h3>
        <p class="small">리더/지원자 토큰을 따로 저장해두면 수락/취소 테스트가 쉬워요.</p>

        <label>role</label>
        <select id="loginRole">
            <option value="leader">LEADER(팀장)</option>
            <option value="applicant">APPLICANT(지원자)</option>
        </select>

        <label>email</label>
        <input id="liEmail" value="user1@test.com" />

        <label>password</label>
        <input id="liPw" value="1234" />

        <div style="margin-top:10px;" class="row">
            <button class="primary" onclick="login()">POST /auth/login</button>
            <button class="gray" onclick="clearTokens()">토큰 초기화</button>
        </div>
    </div>
</div>

<div class="card tokens" style="margin-top:12px;">
    <div class="tokenBox">
        <label>Leader Token</label>
        <textarea id="leaderToken" rows="3" placeholder="login 하면 자동으로 채워짐"></textarea>
    </div>
    <div class="tokenBox">
        <label>Applicant Token</label>
        <textarea id="applicantToken" rows="3" placeholder="login 하면 자동으로 채워짐"></textarea>
    </div>
</div>

<h2>2) 팀/슬롯</h2>
<div class="row">
    <div class="card">
        <h3>팀 생성 (Leader)</h3>

        <label>name</label>
        <input id="teamName" value="홍대 재즈 콤보" />

        <label>intro</label>
        <input id="teamIntro" value="주 1회 합주합니다" />

        <label>goal</label>
        <input id="teamGoal" value="취미 합주" />

        <label>practiceInfo</label>
        <input id="teamPractice" value="SEOUL_MAPO / 토 14:00" />

        <div style="margin-top:10px;">
            <button class="primary" onclick="createTeam()">POST /teams</button>
        </div>

        <label style="margin-top:12px;">teamId</label>
        <input id="teamId" placeholder="응답에서 자동 저장됨" />
    </div>

    <div class="card">
        <h3>슬롯 생성 (Leader)</h3>

        <label>teamId</label>
        <input id="slotTeamId" placeholder="위 teamId 자동 반영" />

        <label>instrument</label>
        <input id="slotInst" value="DRUM" />

        <label>capacity</label>
        <input id="slotCap" type="number" value="1" />

        <label>requiredLevelMin</label>
        <select id="slotLevel">
            <option>HOBBY_UNDER_A_YEAR</option>
            <option selected>HOBBY_UNDER_FIVE_YEAR</option>
            <option>HOBBY_OVER_FIVE_YEAR</option>
            <option>MAJOR_STUDENT</option>
        </select>

        <div style="margin-top:10px;">
            <button class="primary" onclick="createSlot()">POST /teams/{teamId}/slots</button>
        </div>

        <label style="margin-top:12px;">slotId</label>
        <input id="slotId" placeholder="응답에서 자동 저장됨" />
    </div>
</div>

<h2>3) 지원/취소/수락</h2>
<div class="row">
    <div class="card">
        <h3>지원 (Applicant)</h3>
        <label>teamId</label>
        <input id="applyTeamId" placeholder="teamId" />

        <label>slotId</label>
        <input id="applySlotId" placeholder="slotId" />

        <div style="margin-top:10px;">
            <button class="primary" onclick="apply()">POST /teams/{teamId}/slots/{slotId}/join-requests</button>
        </div>

        <label style="margin-top:12px;">joinRequestId</label>
        <input id="joinRequestId" placeholder="응답에서 자동 저장됨" />
    </div>

    <div class="card">
        <h3>취소 (Applicant)</h3>
        <label>joinRequestId</label>
        <input id="cancelJoinRequestId" placeholder="위 joinRequestId 자동 반영" />

        <div style="margin-top:10px;">
            <button class="primary" onclick="cancel()">POST /join-requests/{id}/cancel</button>
        </div>
        <p class="small">APPLIED 상태에서만 취소 성공</p>
    </div>

    <div class="card">
        <h3>수락/거절 (Leader)</h3>
        <label>joinRequestId</label>
        <input id="reviewJoinRequestId" placeholder="위 joinRequestId 자동 반영" />

        <div style="margin-top:10px;" class="row">
            <button class="primary" onclick="accept()">POST /join-requests/{id}/accept</button>
            <button class="gray" onclick="reject()">POST /join-requests/{id}/reject</button>
        </div>
        <p class="small">정원/이미 다른 팀 ACTIVE 멤버 여부에 따라 409가 날 수 있음</p>
    </div>
</div>

<h2>4) 조회</h2>
<div class="row">
    <div class="card">
        <h3>팀 검색 (Public)</h3>

        <label>region (optional)</label>
        <input id="qRegion" placeholder="SEOUL_MAPO" />

        <label>instrument (optional)</label>
        <input id="qInst" placeholder="DRUM" />

        <label>level (optional)</label>
        <select id="qLevel">
            <option value="">(none)</option>
            <option>HOBBY_UNDER_A_YEAR</option>
            <option>HOBBY_UNDER_FIVE_YEAR</option>
            <option>HOBBY_OVER_FIVE_YEAR</option>
            <option>MAJOR_STUDENT</option>
        </select>

        <div style="margin-top:10px;">
            <button class="primary" onclick="searchTeams()">GET /teams</button>
        </div>
    </div>

    <div class="card">
        <h3>내 지원 현황 (Applicant)</h3>
        <label>status (optional)</label>
        <select id="myStatus">
            <option value="">(none)</option>
            <option>APPLIED</option>
            <option>ACCEPTED</option>
            <option>REJECTED</option>
            <option>CANCELED</option>
        </select>

        <div style="margin-top:10px;">
            <button class="primary" onclick="myJoinRequests()">GET /me/join-requests</button>
        </div>
    </div>

    <div class="card">
        <h3>슬롯 지원자 목록 (Leader)</h3>
        <label>teamId</label>
        <input id="listTeamId" placeholder="teamId" />

        <label>slotId</label>
        <input id="listSlotId" placeholder="slotId" />

        <label>status</label>
        <select id="listStatus">
            <option selected>APPLIED</option>
            <option>ACCEPTED</option>
            <option>REJECTED</option>
            <option>CANCELED</option>
        </select>

        <div style="margin-top:10px;">
            <button class="primary" onclick="listSlotRequests()">GET /teams/{teamId}/slots/{slotId}/join-requests</button>
        </div>
    </div>
</div>

<h2>응답 로그</h2>
<pre id="log">{}</pre>

<script>
    function $(id) { return document.getElementById(id); }

    function baseUrl() {
      return $("baseUrl").value.replace(/\/+$/, "");
    }

    function setLog(obj) {
      $("log").textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    function loadTokens() {
      $("leaderToken").value = localStorage.getItem("leaderToken") || "";
      $("applicantToken").value = localStorage.getItem("applicantToken") || "";
    }

    function saveToken(role, token) {
      if (role === "leader") {
        localStorage.setItem("leaderToken", token);
        $("leaderToken").value = token;
      } else {
        localStorage.setItem("applicantToken", token);
        $("applicantToken").value = token;
      }
    }

    function clearTokens() {
      localStorage.removeItem("leaderToken");
      localStorage.removeItem("applicantToken");
      loadTokens();
      setLog({ ok: true, message: "tokens cleared" });
    }

    function leaderAuthHeader() {
      const t = $("leaderToken").value.trim();
      return t ? { "Authorization": "Bearer " + t } : {};
    }

    function applicantAuthHeader() {
      const t = $("applicantToken").value.trim();
      return t ? { "Authorization": "Bearer " + t } : {};
    }

    async function api(method, path, body, headers) {
      const url = baseUrl() + path;
      const opts = {
        method,
        headers: Object.assign({ "Content-Type": "application/json" }, (headers || {}))
      };
      if (body !== undefined && body !== null) {
        opts.body = JSON.stringify(body);
      } else if (method === "POST" || method === "PUT") {
        opts.body = "{}";
      }

      const res = await fetch(url, opts);
      const text = await res.text();
      let json;
      try { json = text ? JSON.parse(text) : null; } catch(e) { json = { raw: text }; }

      if (!res.ok) {
        setLog({ status: res.status, response: json });
        throw new Error("HTTP " + res.status);
      }
      setLog({ status: res.status, response: json });
      return json;
    }

    // ----- Actions -----
    async function signup() {
      const body = {
        email: $("suEmail").value,
        password: $("suPw").value,
        profile: {
          instrument: $("suInst").value,
          level: $("suLevel").value,
          region: $("suRegion").value
        }
      };
      await api("POST", "/auth/signup", body);
    }

    async function login() {
      const role = $("loginRole").value;
      const body = { email: $("liEmail").value, password: $("liPw").value };
      const json = await api("POST", "/auth/login", body);
      const token = json && json.data ? json.data.accessToken : "";
      if (token) saveToken(role, token);
    }

    async function createTeam() {
      const body = {
        name: $("teamName").value,
        intro: $("teamIntro").value,
        goal: $("teamGoal").value,
        practiceInfo: $("teamPractice").value
      };
      const json = await api("POST", "/teams", body, leaderAuthHeader());
      const teamId = json.data.teamId;
      $("teamId").value = teamId;
      $("slotTeamId").value = teamId;
      $("applyTeamId").value = teamId;
      $("listTeamId").value = teamId;
    }

    async function createSlot() {
      const teamId = $("slotTeamId").value || $("teamId").value;
      const body = {
        instrument: $("slotInst").value,
        capacity: Number($("slotCap").value),
        requiredLevelMin: $("slotLevel").value
      };
      const json = await api("POST", `/teams/${teamId}/slots`, body, leaderAuthHeader());
      const slotId = json.data.slotId;
      $("slotId").value = slotId;
      $("applySlotId").value = slotId;
      $("listSlotId").value = slotId;
    }

    async function apply() {
      const teamId = $("applyTeamId").value;
      const slotId = $("applySlotId").value;
      const json = await api("POST", `/teams/${teamId}/slots/${slotId}/join-requests`, {}, applicantAuthHeader());
      const joinRequestId = json.data.joinRequestId;
      $("joinRequestId").value = joinRequestId;
      $("cancelJoinRequestId").value = joinRequestId;
      $("reviewJoinRequestId").value = joinRequestId;
    }

    async function cancel() {
      const id = $("cancelJoinRequestId").value || $("joinRequestId").value;
      await api("POST", `/join-requests/${id}/cancel`, {}, applicantAuthHeader());
    }

    async function accept() {
      const id = $("reviewJoinRequestId").value || $("joinRequestId").value;
      await api("POST", `/join-requests/${id}/accept`, {}, leaderAuthHeader());
    }

    async function reject() {
      const id = $("reviewJoinRequestId").value || $("joinRequestId").value;
      await api("POST", `/join-requests/${id}/reject`, {}, leaderAuthHeader());
    }

    async function searchTeams() {
      const params = new URLSearchParams();
      if ($("qRegion").value.trim()) params.set("region", $("qRegion").value.trim());
      if ($("qInst").value.trim()) params.set("instrument", $("qInst").value.trim());
      if ($("qLevel").value) params.set("level", $("qLevel").value);

      const qs = params.toString() ? ("?" + params.toString()) : "";
      await api("GET", `/teams${qs}`, null, {});
    }

    async function myJoinRequests() {
      const params = new URLSearchParams();
      if ($("myStatus").value) params.set("status", $("myStatus").value);
      const qs = params.toString() ? ("?" + params.toString()) : "";
      await api("GET", `/me/join-requests${qs}`, null, applicantAuthHeader());
    }

    async function listSlotRequests() {
      const teamId = $("listTeamId").value;
      const slotId = $("listSlotId").value;
      const status = $("listStatus").value;
      await api("GET", `/teams/${teamId}/slots/${slotId}/join-requests?status=${encodeURIComponent(status)}`, null, leaderAuthHeader());
    }

    // init
    loadTokens();
</script>
</body>
</html>
